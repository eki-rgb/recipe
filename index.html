<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©ºæ°”ç‚¸é”…é£Ÿè°±ç”Ÿæˆå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fdf6f0;
            margin: 0;
            padding: 15px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        /* ç”µè„‘ç«¯ï¼šå·¦å³å¹¶æ’ */
        .input-section, .output-section {
            flex: 1;
        }

        /* æ‰‹æœºç«¯ï¼šé»˜è®¤éšè—è¾“å‡ºåŒºï¼Œè¾“å…¥åŒºå æ»¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .input-section, .output-section {
                width: 100%;
                flex: none;
            }
            .output-section {
                display: none; /* é»˜è®¤éšè— */
            }
            .output-section.active {
                display: block;
                margin-top: 20px;
            }
            .input-section.hidden {
                display: none;
            }
        }

        .input-section, .recipes-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .output-section {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
        }
        h1 {
            text-align: center;
            color: #d44500;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .nav-tabs {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-tabs button {
            background: none;
            border: none;
            color: #e65c0e;
            font-size: 16px;
            margin: 0 8px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
        }
        .nav-tabs button.active {
            background-color: #ffe0b2;
            font-weight: bold;
        }
        h2 {
            color: #e65c0e;
            border-left: 4px solid #e65c0e;
            padding-left: 10px;
            margin-top: 20px;
            font-size: 1.4em;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }
        button {
            background-color: #e65c0e;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background 0.3s;
            width: 100%;
        }
        button:hover {
            background-color: #c44b0c;
        }
        .recipe-card {
            width: 100%;
            max-width: 400px; /* å›ºå®šæœ€å¤§å®½åº¦ï¼Œç¡®ä¿æˆªå›¾ä¸€è‡´æ€§ */
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .recipe-img-placeholder {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
        }
        .recipe-body {
            padding: 20px;
        }
        .recipe-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            word-break: break-word;
        }
        .recipe-category {
            color: #e65c0e;
            font-size: 14px;
            margin-bottom: 15px;
            display: block;
        }
        .recipe-meta {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
        .meta-item {
            display: flex;
            align-items: center;
        }
        .instructions {
            margin: 15px 0;
            line-height: 1.6;
        }
        .step {
            margin: 8px 0;
            padding-left: 10px;
            border-left: 3px solid #ffe0b2;
        }
        .timeline {
            margin: 15px 0;
            padding: 10px;
            background: #fff8e1;
            border-radius: 8px;
            font-size: 14px;
        }
        .share-btn {
            background-color: #4caf50;
            margin-top: 15px;
        }
        .save-btn {
            background-color: #2196f3;
            margin-top: 10px;
        }
        .archive-hint {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 5px;
        }
        .saved-recipe-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .saved-recipe-item:hover {
            background-color: #f9f9f9;
        }
        .hidden {
            display: none !important;
        }
        .tools-bar {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .tools-bar button {
            flex: 1;
            min-width: 120px;
            padding: 8px;
            font-size: 14px;
        }
        /* è¿”å›æŒ‰é’®ï¼ˆæ‰‹æœºç«¯ç”¨ï¼‰ */
        .back-btn {
            background-color: #9E9E9E;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>ğŸ³ ç©ºæ°”ç‚¸é”…é£Ÿè°±ç”Ÿæˆå™¨</h1>

    <div class="nav-tabs">
        <button id="tab-create" class="active" onclick="showTab('create')">åˆ›å»ºé£Ÿè°±</button>
        <button id="tab-my-recipes" onclick="showTab('my-recipes')">æˆ‘çš„èœè°±</button>
    </div>

    <div class="container">
        <!-- åˆ›å»ºé£Ÿè°±ç•Œé¢ -->
        <div id="create-section" class="input-section">
            <h2>ğŸ“ å¡«å†™é£Ÿè°±</h2>
            <label>é£Ÿè°±åç§°</label>
            <input type="text" id="titleInput" placeholder="ä¾‹å¦‚ï¼šé¦™è„†çƒ¤é¸¡ç¿…">

            <label>åˆ†ç±»</label>
            <select id="categoryInput">
                <option>ç©ºæ°”ç‚¸é”…</option>
            </select>

            <label>é£Ÿæä¸å¤„ç†æ–¹å¼ (æ¯è¡Œä¸€ç§é£Ÿæ)</label>
            <textarea id="ingredientsInput" rows="4" placeholder="é¸¡ç¿… 500g -> æ´—å‡€ï¼Œåˆ’åˆ€&#10;è…Œæ–™ï¼šé…±æ²¹1å‹ºï¼Œè’œæœ« -> è…Œåˆ¶20åˆ†é’Ÿ"></textarea>

            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>æ¸©åº¦ (Â°C)</label>
                    <input type="number" id="tempInput" placeholder="ä¾‹å¦‚ï¼š180">
                </div>
                <div style="flex: 1;">
                    <label>æ—¶é—´ (åˆ†é’Ÿ)</label>
                    <input type="number" id="timeInput" placeholder="ä¾‹å¦‚ï¼š15">
                </div>
            </div>

            <label>ç‰¹æ®Šæ­¥éª¤/æµç¨‹å›¾ (å¯é€‰)</label>
            <textarea id="stepsInput" rows="3" placeholder="0-5åˆ†é’Ÿ: é¢„çƒ­&#10;5-10åˆ†é’Ÿ: æ”¾å…¥é¸¡ç¿…ï¼Œç¿»é¢ä¸€æ¬¡&#10;10-15åˆ†é’Ÿ: æ’’ä¸ŠèŠéº»ï¼Œå®Œæˆ"></textarea>

            <label>ä¸Šä¼ å›¾ç‰‡ (å¯é€‰)</label>
            <input type="file" id="imgFileInput" accept="image/*">

            <button onclick="generateRecipe()">ğŸ¨ ç”Ÿæˆä¾¿ç­¾</button>
        </div>

        <!-- æˆ‘çš„èœè°±ç•Œé¢ -->
        <div id="my-recipes-section" class="recipes-section hidden">
            <h2>ğŸ“ æˆ‘çš„èœè°±</h2>
            <div id="saved-recipes-list"></div>
            <div class="tools-bar">
                <button onclick="exportRecipes()" style="background-color:#4CAF50;">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨</button>
                <button onclick="clearRecipes()" style="background-color:#f44336;">ğŸ—‘ï¸ æ¸…ç©ºèœè°±</button>
                <button onclick="showTab('create')" style="background-color:#9E9E9E;">+ æ–°å»ºé£Ÿè°±</button>
            </div>
        </div>

        <!-- è¾“å‡ºé¢„è§ˆåŒº -->
        <div class="output-section" id="output-section">
            <div id="outputContainer"></div>
            <!-- æ‰‹æœºç«¯è¿”å›æŒ‰é’® -->
            <button class="back-btn hidden" id="backToInputBtn" onclick="showInputView()">â¬… è¿”å›ç¼–è¾‘</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'airFryerRecipes_v2';
        let myRecipes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let currentEditingIndex = -1;

        function showTab(tabName) {
            document.getElementById('create-section').classList.toggle('hidden', tabName !== 'create');
            document.getElementById('my-recipes-section').classList.toggle('hidden', tabName !== 'my-recipes');
            document.getElementById('tab-create').classList.toggle('active', tabName === 'create');
            document.getElementById('tab-my-recipes').classList.toggle('active', tabName === 'my-recipes');

            // æ‰‹æœºç«¯ï¼šåˆ‡æ¢æ ‡ç­¾æ—¶é‡ç½®è§†å›¾
            if (window.innerWidth <= 768) {
                document.getElementById('output-section').classList.remove('active');
                document.getElementById('create-section').classList.remove('hidden');
                document.getElementById('backToInputBtn').classList.add('hidden');
            }

            if (tabName === 'my-recipes') {
                renderSavedRecipes();
            }
        }

        function renderSavedRecipes() {
            const listEl = document.getElementById('saved-recipes-list');
            if (myRecipes.length === 0) {
                listEl.innerHTML = '<p>æš‚æ— ä¿å­˜çš„èœè°±</p>';
                return;
            }
            listEl.innerHTML = myRecipes.map((recipe, index) => 
                `<div class="saved-recipe-item" onclick="editRecipe(${index})">${recipe.title}</div>`
            ).join('');
        }

        function editRecipe(index) {
            const r = myRecipes[index];
            currentEditingIndex = index;
            document.getElementById('titleInput').value = r.title;
            document.getElementById('categoryInput').value = r.category;
            document.getElementById('ingredientsInput').value = r.ingredientsText;
            document.getElementById('tempInput').value = r.temp;
            document.getElementById('timeInput').value = r.time;
            document.getElementById('stepsInput').value = r.stepsText;
            document.getElementById('imgFileInput').value = '';

            showTab('create');
            generateRecipe();
        }

        function readImageAsDataUrl(fileInput, callback) {
            const file = fileInput.files[0];
            if (!file) {
                callback(null);
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => callback(e.target.result);
            reader.readAsDataURL(file);
        }

        function generateRecipe() {
            const title = document.getElementById('titleInput').value || 'æœªå‘½åé£Ÿè°±';
            const category = document.getElementById('categoryInput').value;
            const ingredientsText = document.getElementById('ingredientsInput').value || 'æ— ';
            const temp = document.getElementById('tempInput').value;
            const time = document.getElementById('timeInput').value;
            const stepsText = document.getElementById('stepsInput').value;

            readImageAsDataUrl(document.getElementById('imgFileInput'), function(imgDataUrl) {
                renderRecipeCard(title, category, ingredientsText, temp, time, stepsText, imgDataUrl);

                // æ‰‹æœºç«¯ï¼šç”Ÿæˆåè‡ªåŠ¨åˆ‡æ¢åˆ°è¾“å‡ºè§†å›¾
                if (window.innerWidth <= 768) {
                    document.getElementById('create-section').classList.add('hidden');
                    document.getElementById('output-section').classList.add('active');
                    document.getElementById('backToInputBtn').classList.remove('hidden');
                }
            });
        }

        function renderRecipeCard(title, category, ingredientsText, temp, time, stepsText, imgDataUrl) {
            const recipeCard = document.createElement('div');
            recipeCard.className = 'recipe-card';
            recipeCard.id = 'generated-recipe';

            const body = document.createElement('div');
            body.className = 'recipe-body';
            body.id = 'recipe-content'; // ä»…æ­¤éƒ¨åˆ†ç”¨äºæˆªå›¾

            if (imgDataUrl) {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'recipe-img-placeholder';
                imgDiv.style.backgroundImage = `url(${imgDataUrl})`;
                body.appendChild(imgDiv);
            }

            body.innerHTML += `
                <span class="recipe-category">#${category}</span>
                <div class="recipe-title">${title}</div>
                <div class="instructions">
                    <strong>ğŸ“ é£Ÿæä¸å¤„ç†ï¼š</strong><br>
                    ${ingredientsText.split('\n').map(line => `<span class="step">${line}</span><br>`).join('')}
                </div>
                <div class="recipe-meta">
                    <div class="meta-item">ğŸ”¥ <strong>${temp || '?'}</strong>Â°C</div>
                    <div class="meta-item">â³ <strong>${time || '?'}</strong> åˆ†é’Ÿ</div>
                </div>
            `;

            if (stepsText.trim() !== '') {
                body.innerHTML += `
                    <div class="timeline">
                        <strong>ğŸ”„ ç‰¹æ®Šæµç¨‹ï¼š</strong><br>
                        ${stepsText.split('\n').map(line => `<span class="step">${line}</span><br>`).join('')}
                    </div>
                `;
            }

            recipeCard.appendChild(body);

            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-btn';
            saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¸ºå›¾ç‰‡';
            saveBtn.onclick = async function(e) {
                e.stopPropagation();
                await saveRecipeAsImage();
            };

            const hint = document.createElement('div');
            hint.className = 'archive-hint';
            hint.textContent = 'èœè°±è®°å¾—ä¿å­˜å“¦';

            const archiveBtn = document.createElement('button');
            archiveBtn.className = 'save-btn';
            archiveBtn.style.backgroundColor = '#9c27b0';
            archiveBtn.textContent = 'ğŸ“ å­˜å…¥æˆ‘çš„èœè°±';
            archiveBtn.onclick = function(e) {
                e.stopPropagation();
                const recipeData = {
                    title, category, ingredientsText, temp, time, stepsText, imgDataUrl,
                    timestamp: new Date().toISOString()
                };
                if (currentEditingIndex >= 0) {
                    myRecipes[currentEditingIndex] = recipeData;
                    currentEditingIndex = -1;
                } else {
                    myRecipes.push(recipeData);
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(myRecipes));
                alert('å·²å­˜å…¥â€œæˆ‘çš„èœè°±â€ï¼');
            };

            const shareBtn = document.createElement('button');
            shareBtn.className = 'share-btn';
            shareBtn.textContent = 'ğŸ“¤ åˆ†äº«é£Ÿè°±';
            shareBtn.onclick = function(e) {
                e.stopPropagation();
                if (navigator.share) {
                    navigator.share({
                        title: title,
                        text: `æ¥è‡ªç©ºæ°”ç‚¸é”…é£Ÿè°±ç”Ÿæˆå™¨: ${ingredientsText.substring(0, 100)}...`
                    }).catch(console.error);
                } else {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶å†…å®¹ã€‚');
                }
            };

            recipeCard.appendChild(hint);
            recipeCard.appendChild(archiveBtn);
            recipeCard.appendChild(saveBtn);
            recipeCard.appendChild(shareBtn);

            document.getElementById('outputContainer').innerHTML = '';
            document.getElementById('outputContainer').appendChild(recipeCard);
        }

        async function saveRecipeAsImage() {
            const element = document.getElementById('recipe-content');
            if (!element) {
                alert('è¯·å…ˆç”Ÿæˆä¾¿ç­¾ï¼');
                return;
            }

            try {
                // ä½¿ç”¨ devicePixelRatio æå‡æ¸…æ™°åº¦ï¼Œä½†é™åˆ¶æœ€å¤§ scale ä¸º 3
                const scale = Math.min(window.devicePixelRatio || 2, 3);
                const canvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: scale,       // é«˜æ¸…å…³é”®ï¼
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });
                canvas.toBlob(function(blob) {
                    saveAs(blob, "æˆ‘çš„é£Ÿè°±.png");
                }, 'image/png', 1.0);
            } catch (error) {
                console.error('æˆªå›¾å¤±è´¥:', error);
                alert('ä¿å­˜å›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚\nå»ºè®®ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨ã€‚');
            }
        }

        function showInputView() {
            document.getElementById('create-section').classList.remove('hidden');
            document.getElementById('output-section').classList.remove('active');
            document.getElementById('backToInputBtn').classList.add('hidden');
        }

        function exportRecipes() {
            if (myRecipes.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„èœè°±');
                return;
            }
            const dataStr = JSON.stringify(myRecipes, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            saveAs(blob, 'æˆ‘çš„ç©ºæ°”ç‚¸é”…èœè°±.json');
        }

        function clearRecipes() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²ä¿å­˜çš„èœè°±å—ï¼Ÿ')) {
                myRecipes = [];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(myRecipes));
                renderSavedRecipes();
                alert('å·²æ¸…ç©º');
            }
        }

        // åˆå§‹åŒ–
        showTab('create');
    </script>
</body>
</html>